#!/usr/bin/env bash

HOME_REPLACER=""                                          # default to a noop
echo "$HOME" | grep -E "^[a-zA-Z0-9\-_/.@]+$" &>/dev/null # chars safe to use in sed
HOME_SED_SAFE=$?
if [ $HOME_SED_SAFE -eq 0 ]; then # $HOME should be safe to use in sed
	HOME_REPLACER="s|^$HOME/|~/|"
fi

project_dir=$(zoxide query -l | fzf --reverse)

if [ "$project_dir" = "" ]; then # no result
  exit 0                     # exit silently
fi

if [ $HOME_SED_SAFE -eq 0 ]; then
  project_dir=$(echo "$project_dir" | sed -e "s|^~/|$HOME/|") # get real home path back
fi

directory=$(basename "$project_dir")
session_name=""
if [ "$1" = "" ]; then
  session_name=$(echo "$directory" | tr ' .:' '_')
else
  session_name="$1"
fi

# We're outside of zellij, so lets create a new session or attach to a new one.
if [[ -z $ZELLIJ ]]; then
	cd $project_dir
	zellij attach $session_name -c options --default-cwd $project_dir
	exit 0
fi

zellij action new-tab --layout "default" --name $session_name --cwd $project_dir
zellij action go-to-tab-name $session_name

