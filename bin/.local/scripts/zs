#!/usr/bin/env bash

HOME_REPLACER=""                                          # default to a noop
echo "$HOME" | grep -E "^[a-zA-Z0-9\-_/.@]+$" &>/dev/null # chars safe to use in sed
HOME_SED_SAFE=$?
if [ $HOME_SED_SAFE -eq 0 ]; then # $HOME should be safe to use in sed
	HOME_REPLACER="s|^$HOME/|~/|"
fi

project_dir=$(zoxide query -l | fzf --reverse)

if [ "$project_dir" = "" ]; then # no result
  exit 0                     # exit silently
fi

if [ $HOME_SED_SAFE -eq 0 ]; then
  project_dir=$(echo "$project_dir" | sed -e "s|^~/|$HOME/|") # get real home path back
fi

directory=$(basename "$project_dir")
session_name=""
if [ "$1" = "" ]; then
  session_name=$(echo "$directory" | tr ' .:' '_')
else
  session_name="$1"
fi

get_layout() {
  layout="default"
  layout_dir=$(zellij setup --check | grep "LAYOUT DIR" | grep -o '".*"' | tr -d '"')

  if [ "$layout_dir" != "" ]; then
    layouts=$(find $layout_dir | tail -n+2)
    layouts="$layouts default"
    layout_path=$(echo "$layouts" | fzf --preview 'bat {}')
    layout=$(basename "$layout_path" | sed 's/\.kdl$//')
  fi

  if [ "$layout" = "" ]; then
    layout="default"
  fi

  echo $layout
}

# We're outside of zellij, so lets create a new session or attach to a new one.
if [[ -z $ZELLIJ ]]; then
  session=$(zellij list-sessions | grep "^$session_name$")

  cd $project_dir

  if [ "$session" = "" ]; then
    layout=$(get_layout)

    zellij -s $session_name --layout $layout options --default-cwd $project_dir
    exit 0
  fi

	zellij attach $session_name -c options --default-cwd $project_dir
	exit 0
fi

layout=$(get_layout)

zellij action new-tab --layout $layout --name $session_name --cwd $project_dir
zellij action go-to-tab-name $session_name

